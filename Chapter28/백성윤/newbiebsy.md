# Chapter28 다른 서버로 데이터를 보내려면 어떻게 하면 되나요?

### 네트워크 프로그래밍이란
> - 네트워킹 : 다른 장비와 데이터를 주고 받는 작업
> - TCP : 연결 기반 프로토콜, 상대방이 데이터를 받았는지를 확실히 보장 받을 수 있다. (HTTP, FTP, Telnet 등이 TCP 통신을 한다.)
>   - 데이터가 전송된다는 보장을 받을 수 있는 대신, UDP 보다 비싸고 느리며 무겁다.
> - UDP : 비연결형 프로토콜, 정보를 주고 받을 때 정보를 보내거나 받는다는 신호절차를 거치지 않는다.
>   - 데이터의 전송이 꼭 보장되지 않아도 되는 경우 사용한다.
> 
> 일반적인 웹 애플리케이션에서는 80 번호의 포트를 사용한다. (포트는 16비트로 구성되어 65,535까지 사용 가능하다.)

### 소켓 통실을 하기 위해서 알아야 하는 Socket 클래스
> TCP 통신을 자바엣어 수행하려면 Socket 클래스를 사용하면 된다.
> 
> Socket 클래스는 데이터를 보내는 쪽(보통 클라이언트)에서 객체를 생성하여 사용한다.   
> 데이터를 받는 쪽(보통 서버)에서 클라이언트 요청을 받으면, 요청에 대한 Socket 객체를 생성하여 데이터를 처리한다.   
> 
> 서버에서는 데이터를 ServerSocket이라는 클래스를 사용하여 데이터를 받는다. (서버에서 요청에 대한 Socket 객체를 만드는 걸 ServerSocket 클래스에서 제공하는 메소드에서 자동으로 해준다.)
> 
> ServerSocket 클래스의 생성자와 메소드를 알아보자.

| 생성자                                                      | 설명                                                             |
|----------------------------------------------------------|----------------------------------------------------------------|
| ServerSocket()                                           | 서버 소켓 객체만 생성한다.                                                |
| ServerSocket(int port)                                   | 지정된 포트를 사용하는 서버 소켓을 설정한다.                                      |
| ServerSocket(int port, int backlog)                      | 지정된 포트와 backlog 개수를 가지는 소켓을 생성한다.                              |
| ServerSocket(int port, int backlog, InetAddress bindarr) | 지정된 포트와 backlog 개수를 가지는 소켓을 생성하며, bindArr에 있는 주소에서의 접근만을 허용한다. |

> 처음 보는 backlog 라는 값은 큐의 개수라고 보면된다. (ServerSocket 객체가 바빠서 연결 요청을 처리 못하고 대기시킬 때가 있는데, 그 때의 최대 대기 개수라고 보면 된다.)
> 
> 두 번째 생성자는 backlog의 개수를 지정하지 않는데, 이런 경우 backlog의 개수는 50개가 된다.(필요할 시에 이 개수를 적절하게 증가시키는 것이 좋다.)
> 
> InetAddress라는 클래스의 객체인 bindArr은 특정 주소에서만 접근이 가능하도록 지정할 때 사용한다.
> 
> 매개 변수가 없는 ServerSocket() 생성자는 별도로 연결작업을 해야만 대기가 가능하다.(나머지 생성자들을 통해 만든 객체는 생성되자 마자 연결을 대기할 수 있는 상태가 된다.)

| 리턴 타입  | 메소드      | 설명                                    |
|--------|----------|---------------------------------------|
| Socket | accept() | 새로운 소켓 연결을 기다리고, 연결이 되면 Socket 객체를 리턴 |
| void   | close()  | 소켓 연결을 종료                             |

> 여기서 close() 메소드 처리를 하지 않고, JVM이 계속 동작중이라면, 해당 포트는 동작하는 서버나 PC에서 다른 프로그램이 사용할 수 없다.
>
> 데이터를 받는 서버에서는 클라이언트에서 접속을 하면 Socket 객체를 생성하지만, 데이터를 보내는 클라이언트에서는 Socket 객체를 직접 생성해야 한다.
> 
> Socket 클래스의 생성자는 매우 많이 존재하는데, host와 port를 지정하는 생성자를 사용하는 것이 가장 편하다.   
> 생성자들 중에서는 서버를 지정하는 생성자들은 객체 생성과 함께 지정된 서버에 접속을 한다.
> 
> Socket 클래스도 ServerSocket 클래스와 마찬가지로 close() 메소드를 사용하여 소켓을 닫는다.   
> 소켓 연결에 문제가 있을 경우 끊어주는 Timeout 관련 메소드는 API를 참고하여 꼭 확인해봐야 한다.

> 참고로 클라이언트에서 서버로만 데이터를 전송할 수 있는 것이 아니라, 반대도 얼마든지 가능하다. (꼭 단방향으로만 전달되는 것이 아니다.)

### UDP 통신을 위해서 알아야 하는 Datagram 관련 클래스

> UDP 통신은 TCP와 달리 데이터가 제대로 전달되었다는 보장을 하지 않는다. 그러므로, UDP 관련 프로그램은 데이터의 유실이 있어도 문제가 없을 때에만 사용하는 것이 좋다.
> 
> 자바에서 UDP 통신을 하려면 TCP와 마찬가지로 데이터를 주고 받기 위한 클래스가 필요하다. 그런데, TCP와는 다르게, 하나의 클래스에서 보내는 역할과 받는 역할을 모두 수행할 수 있다.   
> 그리고, TCP에서는 스트림 객체를 이용하여 데이터를 주거나 받지만,
> UDP 통신을 할 때에는 스트림을 사용하지 않고 DatagramPacket 이라는 클래스를 사용한다.
> 
> 먼저 DatagramSocket 클래스의 생성자를 살펴보자

| 생성자                                            | 설명                                     |
|------------------------------------------------|----------------------------------------|
| DatagramSocket()                               | 소켓 객체 생성후 사용 가능한 포트로 대기                |
| DatagramSocket(DatagramSocketImpl impl)        | 사용자가 지정한 SocketImpl 객체를 사용하여 소켓 객체만 생성 |
| DatagramSocket(int port)                       | 소켓 객체 생성 후 지정된 port로 대기                |
| DatagramSocket(int port, InetAddress address)  | 소켓 객체 생성 후 address와 port를 사용하는 서버에 연결  |
| DatagramSocket(SocketAddress address)          | 소켓 객체 생성 후 address에 지정된 서버로 연결         |

> DatagramSocket 클래스도 일반적인 연결을 하는 클래스들처럼 더 이상 사용을 할 필요가 없을 때에는 close() 메소드를 호출해야한다.   
> 데이터를 받기 위해 대기할 때에는 receive() 메소드를 사용하고, 데이터를 보낼 때에는 send() 메소드를 사용하면 된다.

| 리턴 타입 | 메소드                            | 설명                                                   |
|-------|--------------------------------|------------------------------------------------------|
| void  | receive(DatagramPacket packet) | 메소드 호출시 요청을 대기하고, 만약 데이터를 받았을 때에는 packet 객체에 데이터를 저장 |
| void  | send(DatagramPacket packet)    | packet 객체에 있는 데이터 전송                                 |

> 이 외에도 메소드들이 존재하지만, 간단한 사용을 위해서는 위의 메소드로 데이터를 주고 받는 것은 충분하다.
> 
> 위의 메소드의 매개 변수로 사용되는 DatagramPacket 클래스의 생성자는 아래와 같다.
> (단 하나만 데이터를 받기 위한 생성자이며, 나머지 생성자들은 데이터를 전송하기 위한 생성자들이다.)

| 생성자                                                                               | 설명                                                         |
|-----------------------------------------------------------------------------------|------------------------------------------------------------|
| DatagramPacket(byte[] buf, int length)                                            | length의 크기를 갖는 데이터를 "받기"위한 객체 생성                           |
| DatagramPacket(byte[] buf, int length, InetAddress address, int port)             | 지정된 address와 port로 데이터를 전송하기 위한 객체 생성                      |
| DatagramPacket(byte[] buf, int offset, int length)                                | 버퍼의 offset이 할당되어 있는 데이터를 전송하기 위한 객체 생성                     |
| DatagramPacket(byte[] buf, int offset, int length, InetAddress address, int port) | 버퍼의 offset이 할당되어 있고, 지정된 address와 port로 데이터를 전송하기 위한 객체 생성 |
| DatagramPacket(byte[] buf, int offset, int length, SocketAddress address)         | 버퍼의 offset이 할당되어 있고, 지정된 소켓 address로 데이터를 전송하기 특이한 객체 생성   |
| DatagramPacket(byte[] buf, int length, SocketAddress address)                     | 지정된 소켓 address로 데이터를 전송하기 위한 객체 생성                         |

> 여기서 byte 배열은 전송되는 데이터이다. 그리고 offset은 전송되는 byte 배열의 첫 위치이다. 만약 offset이 1이라면 배열의 0번째부터가 아닌 1번째부터 데이터를 전송한다.
> 
> length 는 데이터의 크기를 의미하는데, 이 값이 byte 배열의 크기보다 작으면 java.lang.IllegalArgumentException이 발생한다.
> 
> DatagramPacket 클래스의 메소드 중 getData()와 getLength() 두 가지 메소드는 꼭 알아야한다.
> 
> getData() 메소드는 byte 배열로 전송받은 데이터를 리턴하고, getLength() 메소드는 전송받은 데이터의 길이를 int 타입으로 리턴한다.

> **UDP는 TCP와 다르게 데이터가 성공적으로 전송되지 않아도 예외를 발생시키지 않는다. 때문에 서버 프로그램은 수행하지 않고, 클라이언트 프로그램만을 수행하더라도 이상 없이 프로그램이 동작하고 종료된다.**
> 
> **TCP에서는 ConnectException 이 발생한다.**

#### 자바에서 웹 페이지 요청을 하려면
> 자바에서 인터넷을 통하여 웹 페이지 요청을 할 수도 있다. 
> 
> 이 때에는 일반적으로 Apache의 http Components를 많이 사용한다.
